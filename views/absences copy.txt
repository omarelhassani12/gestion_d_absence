<!-- absence.ejs -->
<!DOCTYPE html>
<html lang="fr">
<%- include('partials/header') %>

<body class="hold-transition sidebar-mini layout-fixed">
    <div class="wrapper">
        <%- include('partials/navbar') %>
        <%- include('partials/aside') %>

        <div class="content-wrapper">
            <section class="content-header">
                <div class="container-fluid">
                    <div class="row mb-2">
                        <div class="col-sm-6">
                            <h1>Absences des Stagiaires</h1>
                        </div>
                        <div class="col-sm-6">
                            <ol class="breadcrumb float-sm-right">
                                <li class="breadcrumb-item"><a href="#">Accueil</a></li>
                                <li class="breadcrumb-item active">Absences</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </section>

            <section class="content">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <div id="success-alert" class="alert alert-success" role="alert" style="display: none;">
                                        Absence enregistrée avec succès
                                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
                                    </div>
                                    <div id="delete-success-alert" class="alert alert-success alert-dismissible fade show d-none" role="alert">
                                        Absence supprimée avec succès
                                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
                                    </div>

                                    <div class="row">
                                        <div class="col-sm-12 text-right">
                                            <div class="col-auto ms-auto d-print-none">
                                                <div class="d-flex justify-content-end">
                                                    <!-- The "Nouvelle Absence" button -->
                                                    <a href="/stagaire" class="btn btn-primary d-none d-sm-inline-block">
                                                        Nouvelle Absence
                                                    </a>
                                                    
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- /.card-header -->
                                <div class="card-body">
                                    <table id="example1" class="table table-bordered table-striped">
                                        <thead>
                                            <tr>
                                                <th class="text-center">CEF</th>
                                                <th class="text-center">Stagiaire</th>
                                                <th class="text-center">Fonction</th>
                                                <th class="text-center">Total d'Heures Manquées</th>
                                                <th class="text-center">Total d'Heures Manquées</th>
                                                <th class="text-center">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% // Create an object to store the total hours missed for each user
                                            const totalHoursMissedByUser = {};
                                            absences.forEach(absence => {
                                                // Find the corresponding stagiaire based on stagiaire_id
                                                const stagiaire = stagiaires.find(st => st.id === (absence.stagiaire_id || null)); // Use null if 'stagiaire_id' is undefined
                                                const totalHeuresManquees = absence.total_heures_manquees;
                                                
                                                // Update the total hours missed for the user
                                                if (stagiaire && stagiaire.id) {
                                                    if (!totalHoursMissedByUser[stagiaire.id]) {
                                                        totalHoursMissedByUser[stagiaire.id] = {
                                                            stagiaire,
                                                            totalHeuresManquees,
                                                        };
                                                    } else {
                                                        totalHoursMissedByUser[stagiaire.id].totalHeuresManquees += totalHeuresManquees;
                                                    }
                                                }
                                            });
                                            // Loop through the grouped data and display the results
                                            Object.values(totalHoursMissedByUser).forEach(data => {
                                                const { stagiaire, totalHeuresManquees } = data;
                                                const group = groups.find(grp => grp.id === stagiaire.groupId); // Find the group using groupId
                                        
                                                const PRMG = `تطبيقا للقانون الداخلي المعمول به داخل مؤسسات التكوين المهني وخاصة الفصل الخامس المتعلق بالمواظبة والسلوك فقد تم توجيه عقوبة توبيخ للمتدرب(ة) ${stagiaire.firstName} ${stagiaire.lastName} المسجل بشعبة ${group ? group.name : 'Unknown Group'} وذلك نظرا للغياب المتكرر والغير مبرر مع خصم خمس نقط من نقط المواظبة.`;
                                        %>
                                                <tr>
                                                    <td class="text-center"><%= stagiaire && stagiaire.CEF ? stagiaire.CEF : 'Unknown CEF' %></td>
                                                    <td class="text-center"><%= stagiaire ? `${stagiaire.firstName} ${stagiaire.lastName}` : 'Unknown Stagiaire' %></td>
                                                    <td class="text-center">
                                                        <% if (totalHeuresManquees >= 2.5 && totalHeuresManquees < 7.5) { %>
                                                        <a href="/absence/download-pdf/<%= stagiaire.id %>" download="1er_M.G.pdf">1er M.G</a>
                                                        <% } else if (totalHeuresManquees >= 7.5 && totalHeuresManquees < 15.5) { %>
                                                        <a href="/absence/download-pdf/<%= stagiaire.id %>" download="2eme_M.G.pdf">2eme M.G</a>
                                                        <% } else if (totalHeuresManquees >= 15.5 && totalHeuresManquees < 17.5) { %>
                                                        <a href="/absence/download-pdf/<%= stagiaire.id %>" download="1er_Aver.pdf">1er Aver</a>
                                                        <% } else if (totalHeuresManquees >= 17.5 && totalHeuresManquees < 22.5) { %>
                                                        <a href="/absence/download-pdf/<%= stagiaire.id %>" download="2eme_Aver.pdf">2eme Aver</a>
                                                        <% } else if (totalHeuresManquees >= 22.5 && totalHeuresManquees < 25.5) { %>
                                                        <a href="/absence/download-pdf/<%= stagiaire.id %>" download="Blame.pdf">Blame</a>
                                                        <% } else if (totalHeuresManquees >= 27.5 && totalHeuresManquees < 32.5) { %>
                                                        <a href="/absence/download-pdf/<%= stagiaire.id %>" download="2eme_M.G.pdf">2eme M.G</a>
                                                        <% } else if (totalHeuresManquees >= 32.5 && totalHeuresManquees < 35.5) { %>
                                                        <a href="/absence/download-pdf/<%= stagiaire.id %>" download="Exclusion.pdf">Exclusion</a>
                                                        <% } else if (totalHeuresManquees > 52.5) { %>
                                                        <a href="/absence/download-pdf/<%= stagiaire.id %>" download="Urgent.pdf">Urgent</a>
                                                        <% } %>
                                                    </td>
                                                    <td class="text-center"><%= totalHeuresManquees %></td>
                                                    <td class="text-center"><%= PRMG %></td>
                                                    <td class="text-center">
                                                        <a href="/detail-page/<%= stagiaire.id %>" class="btn btn-info detail-btn">
                                                            <i class="fas fa-info-circle"></i> 
                                                        </a>
                                                        <button class="btn btn-success update-btn" onclick="goToUpdatePage('<%= stagiaire.id %>');">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <form id="delete-form-<%= stagiaire.id %>" style="display: inline;">
                                                            <input type="hidden" name="_method" value="DELETE">
                                                            <button class="btn btn-danger delete-btn" onclick="confirmDelete(event, '<%= stagiaire.id %>');">
                                                                <i class="fas fa-trash-alt"></i>
                                                            </button>
                                                        </form>
                                                    </td>
                                                </tr>
                                            <% }); %>
                                        </tbody>
                                    </table>
                                    
                                    
                                </div>
                                <!-- /.card-body -->
                            </div>
                            <!-- /.card -->
                        </div>
                        <!-- /.col -->
                    </div>
                    <!-- /.row -->
                </div>
                <!-- /.container-fluid -->
            </section>
            <!-- /.content -->
        </div>
        <!-- /.content-wrapper -->

        <%- include('partials/script') %>





        <!-- Modal delete -->
<div class="modal fade" id="confirmationModal" tabindex="-1" role="dialog" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmationModalLabel">Supprimer l'Absence</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Fermer">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Êtes-vous sûr de vouloir supprimer cette absence ?
            </div>
            <div class="modal-footer d-flex justify-content-between">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-button">Supprimer</button>
            </div>
        </div>
    </div>
</div>

<script>
    function confirmDelete(event, absenceId) {
        event.preventDefault(); // Empêcher la soumission du formulaire

        // Récupérer l'élément modal
        var modal = document.getElementById('confirmationModal');

        // Récupérer les boutons dans la modal
        var confirmButton = modal.querySelector('#confirm-delete-button');
        var closeButton = modal.querySelector('.btn-secondary');

        // Mettre à jour l'événement click du bouton de confirmation
        confirmButton.onclick = function () {
            // Effectuer l'opération de suppression
            fetch(`/absence/${absenceId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Absence supprimée avec succès
                    $('#delete-success-alert').removeClass('d-none'); // Show success alert for delete
                    setTimeout(function () {
                        $('#delete-success-alert').addClass('d-none'); // Hide the delete success alert after 3 seconds
                    }, 3000);
                    location.reload(); // Reload the page
                } else {
                    // Erreur lors de la suppression de l'absence
                    console.error('Une erreur est survenue lors de la suppression de l\'absence : ' + data.error);
                }
            })
            .catch(error => {
                console.error(error);
                console.error('Une erreur est survenue lors de la suppression de l\'absence');
            });

            // Fermer la modal
            $(modal).modal('hide');
        };

        // Afficher la modal
        $(modal).modal('show');

        // Mettre à jour l'événement click du bouton de fermeture
        closeButton.onclick = function () {
            // Fermer la modal
            $(modal).modal('hide');
        };
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- //seances caluc -->
<script>
    function updateTotalHoursMissed() {
        const checkboxes = document.querySelectorAll('input[name="is_justified"]:checked');
        const totalHoursMissedInput = document.getElementById('totalHoursMissed');
        const hoursMissed = checkboxes.length * 2.5;
        totalHoursMissedInput.value = hoursMissed;
    }
</script>
<!-- //for the to day date  -->
<script>
    // Get the current date in YYYY-MM-DD format
    const today = new Date().toISOString().split('T')[0];
    
    // Set the value of the input to today's date
    document.getElementById('observationDate').value = today;
</script>
<!-- <script>
// Mettre à jour l'absence
function goToUpdatePage(observationId) {
    window.location.href = `/absence/update/${observationId}`;
}
</script> -->


<!-- Bootstrap Bundle with Popper -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<!-- jQuery -->






    </div>
    <!-- ./wrapper -->



</body>
</html>
