<!-- users.ejs -->
<!DOCTYPE html>
<html lang="fr">
<%- include('partials/header') %>

<body class="hold-transition sidebar-mini layout-fixed">
    <div class="wrapper">
        <%- include('partials/navbar') %>
        <%- include('partials/aside') %>

        <div class="content-wrapper">
            <section class="content-header">
                <div class="container-fluid">
                    <div class="row mb-2">
                        <div class="col-sm-6">
                            <h1>Utilisateurs</h1>
                        </div>
                        <div class="col-sm-6">
                            <ol class="breadcrumb float-sm-right">
                                <li class="breadcrumb-item"><a href="#">Accueil</a></li>
                                <li class="breadcrumb-item active">Utilisateurs</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </section>

            <section class="content">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <div class="row">
                                        <div class="col-sm-12 text-right">
                                            <div class="col-auto ms-auto d-print-none">
                                                <div class="d-flex justify-content-end">
                                                    <!-- <label for="excel-file" class="btn btn-success d-none d-sm-inline-block">
                                                        Insérer une liste
                                                    </label>
                                                    <input type="file" id="excel-file" accept=".xlsx, .xls" style="display: none" />
                                                     -->
                                                    <a href="#" class="btn btn-primary d-none d-sm-inline-block" data-bs-toggle="modal" data-bs-target="#modal-report" id="new-user-button">
                                                        Nouvel Utilisateur
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- /.card-header -->
                                <div class="card-body">
                                    <table id="example1" class="table table-bordered table-striped">
                                        <thead>
                                            <tr>
                                                <th class="text-center">Nom Complete</th>
                                                <th class="text-center">Email</th>
                                                <th class="text-center">Password</th>
                                                <th class="text-center">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% if (!users || users.length === 0) { %>
                                            <tr>
                                                <td colspan="5" style="text-align:center">Aucun enregistrement d'utilisateur trouvé.</td>
                                            </tr>
                                            <% } else { %>
                                            <% users.forEach((user) => { %>
                                                <tr>
                                                    <td class="text-center"><%= user.nom_complete %></td>
                                                    <td class="text-center"><%= user.email %></td>
                                                    <td class="text-center"><%= user.password %></td>
                                                    <td class="text-center">
                                                        <button class="btn btn-success update-btn" onclick="goToUpdatePage('<%= user.id %>')">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <form id="delete-form-<%= user.id %>" action="/user/<%= user.id %>" method="POST" style="display: inline;">
                                                            <input type="hidden" name="_method" value="DELETE">
                                                            <button class="btn btn-danger delete-btn" onclick="confirmDelete(event, '<%= user.id %>')" id="delete-button-<%= user.id %>">
                                                                <i class="fas fa-trash-alt"></i>
                                                            </button>
                                                        </form>
                                                    </td>
                                                </tr>
                                            <% }) %>
                                            <% } %>
                                        </tbody>
                                    </table>
                                </div>
                                <!-- /.card-body -->
                            </div>
                            <!-- /.card -->
                        </div>
                        <!-- /.col -->
                    </div>
                    <!-- /.row -->
                </div>
                <!-- /.container-fluid -->
            </section>
            <!-- /.content -->
        </div>
        <!-- /.content-wrapper -->

        <%- include('partials/script') %>
    </div>
    <!-- ./wrapper -->
  <!-- Modal insert -->
<div class="modal fade" id="modal-report" tabindex="-1" role="dialog" aria-labelledby="modal-report" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-title">Nouvel Utilisateur</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <form id="create-user-form" action="/user" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Prénom</label>
                        <input type="text" class="form-control" name="firstName" placeholder="Prénom">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Nom</label>
                        <input type="text" class="form-control" name="lastName" placeholder="Nom">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="email" placeholder="Email">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary" id="create-user-button">Créer l'Utilisateur</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal delete -->
<div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Supprimer l'Utilisateur</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Fermer">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Êtes-vous sûr de vouloir supprimer cet utilisateur ?
            </div>
            <div class="modal-footer d-flex justify-content-between">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-button">Supprimer</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Insert and Delete User Scripts -->
<script>
    // Insert User
    $('#create-user-form').on('submit', function(event) {
        event.preventDefault();

        var form = $(this);
        var url = form.attr('action');
        var formData = form.serialize();

        $.ajax({
            url: url,
            type: 'POST',
            data: formData,
            success: function(response) {
                console.log('Utilisateur créé avec succès');

                // Fermer la fenêtre modale
                $('#modal-report').modal('hide');

                // Récupérer les données de l'utilisateur créé
                var createdUser = response.user;

                // Ajouter les nouvelles données de l'utilisateur au tableau
                var tableBody = $('#example1 tbody');
                var newRow = '<tr>' +
                    '<td>' + createdUser.firstName + '</td>' +
                    '<td>' + createdUser.lastName + '</td>' +
                    '<td>' + createdUser.email + '</td>' +
                    '<td>' + (createdUser.groupId !== 0 ? 'Groupe ' + createdUser.groupId : 'Aucun Groupe') + '</td>' +
                    '<td>' +
                    '<button class="btn btn-success update-btn" onclick="goToUpdatePage(' + createdUser.id + ')">' +
                    '<i class="fas fa-edit"></i>' +
                    '</button>' +
                    '<form id="delete-form-' + createdUser.id + '" action="/user/' + createdUser.id + '" method="POST" style="display: inline;">' +
                    '<input type="hidden" name="_method" value="DELETE">' +
                    '<button class="btn btn-danger delete-btn" onclick="confirmDelete(event, \'' + createdUser.id + '\')" id="delete-button-' + createdUser.id + '">' +
                    '<i class="fas fa-trash-alt"></i>' +
                    '</button>' +
                    '</form>' +
                    '</td>' +
                    '</tr>';

                tableBody.append(newRow);

                // Réinitialiser le formulaire
                form[0].reset();

                // Afficher temporairement les données de l'utilisateur nouvellement créé
                var alertDiv = $('<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                    'Utilisateur créé avec succès !' +
                    '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>' +
                    '</div>');

                $('.content-header').after(alertDiv);

                // Masquer automatiquement l'alerte après 3 secondes
                setTimeout(function() {
                    alertDiv.alert('close');
                }, 3000);
            },
            error: function(xhr, status, error) {
                console.error('Une erreur est survenue lors de la création de l\'utilisateur :', error);
            }
        });
    });

    // Supprimer l'utilisateur
    function confirmDelete(event, userId) {
        event.preventDefault(); // Empêcher la soumission du formulaire

        // Récupérer l'élément modal
        var modal = document.getElementById('exampleModalCenter');

        // Récupérer les boutons dans la modal
        var confirmButton = modal.querySelector('#confirm-delete-button');
        var closeButton = modal.querySelector('.btn-secondary');

        // Mettre à jour l'événement click du bouton de confirmation
        confirmButton.onclick = function() {
            // Effectuer l'opération de suppression
            fetch(`/user/${userId}`, {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Utilisateur supprimé avec succès
                        alert('Utilisateur supprimé avec succès');
                        window.location.href = window.location.href; // Recharger la page
                    } else {
                        // Erreur lors de la suppression de l'utilisateur
                        console.error('Une erreur est survenue lors de la suppression de l\'utilisateur : ' + data.error);
                    }
                })
                .catch(error => {
                    console.error(error);
                    console.error('Une erreur est survenue lors de la suppression de l\'utilisateur');
                });

            // Fermer la modal
            $(modal).modal('hide');
        };

        // Afficher la modal
        $(modal).modal('show');

        // Mettre à jour l'événement click du bouton de fermeture
        closeButton.onclick = function() {
            // Fermer la modal
            $(modal).modal('hide');
        };
    }

    // Mettre à jour l'utilisateur
    function goToUpdatePage(userId) {
        window.location.href = `/user/update/${userId}`;
    }
</script>
</body>
</html>
